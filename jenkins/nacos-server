#!groovy
pipeline {
    agent any

    //常量参数
    environment{
        service_name="nacos-server-v2.2.2-slim"
        mirror_name="nacos/nacos-server:v2.2.2-slim"
    }

    //部署一个容器的nacos-server单机版
    stages {
        stage("docker run nacos-server") {
            steps{
                sh '''
                    if !(test -z "$(docker ps -a | grep -w ${service_name} )") then
                        docker stop ${service_name}
                        docker rm ${service_name}
                    fi

                    docker run -d \
                        --name ${service_name} \
                        --restart always \
                        -p 8848:8848 \
                        -p 9848:9848 \
                        -e MODE=standalone \
                        -e SPRING_DATASOURCE_PLATFORM=mysql \
                        -e MYSQL_SERVICE_HOST="localhost" \
                        -e MYSQL_SERVICE_PORT=3306 \
                        -e MYSQL_SERVICE_DB_NAME="nacos_server" \
                        -e MYSQL_SERVICE_USER="root" \
                        -e MYSQL_SERVICE_PASSWORD="123456" \
                        -e MYSQL_SERVICE_DB_PARAM="characterEncoding=utf8&connectTimeout=1000&socketTimeout=3000&autoReconnect=true&useSSL=false&allowPublicKeyRetrieval=true" \
                        -e SPRING_DATASOURCE_PLATFORM="mysql" \
                        ${mirror_name}
                '''
            }
        }
    }
}
