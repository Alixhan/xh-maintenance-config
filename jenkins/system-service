#!groovy
pipeline {
    agent any
    //环境变量
    tools {
        jdk 'jdk17'
        maven 'maven3.9.1'
    }

    //常量参数
    environment {
        cred_id = "github"
        git_project_url = "https://github.com/Alixhan/xh-admin-backend.git"
        project_name = "system/service"
        service_name = "xh-admin-system-service"
        mirror_name = "${service_name}:latest"
        git_project_branch = "main"
        outer_port = "9001"
        inner_port = "2000"
        NACOS_SERVER_ADDR = "localhost:8848"
    }

    stages {
        stage("fetch code") {
            steps {
//                git credentialsId:cred_id, url:git_project_url, branch:git_project_branch
                git url: git_project_url, branch: git_project_branch
            }
        }
        stage("spring-boot:build-image") {
            steps {
                script {
                    def runScript = "mvn spring-boot:build-image -f ${project_name}/pom.xml"
                    if (isUnix()) {
                        sh runScript
                    } else {
                        bat runScript
                    }
                }

            }
        }
        stage("deploy service") {
            steps {
                script {
                    // docker run脚本
                    def runScript = "docker run " +
                            " --name ${service_name} " +
//                            " -p ${outer_port}:${inner_port} " +
                            " --restart=always " +
                            " --net=host " +
                            " -e NACOS_SERVER_ADDR=\"${NACOS_SERVER_ADDR}\" " +
                            " -e PORT=\"${outer_port}\" " +
                            " -d ${mirror_name}"
                    if (isUnix()) {
                        try {
                            sh "docker stop ${service_name}"
                            sh "docker rm ${service_name}"
                        } catch (Exception e) {
                            echo '无容器可删'
                        }
                        sh runScript
                    } else {
                        try {
                            bat "docker stop ${service_name}"
                            bat "docker rm ${service_name}"
                        } catch (Exception e) {
                            echo '无容器可删'
                        }
                        bat runScript
                    }
                }
            }
        }
    }
}
